# SIP Server

Профессиональный SIP сервер на Node.js для управления звонками между абонентами с короткими номерами от 100 до 110.

## Возможности

- ✅ Регистрация SIP абонентов с номерами 100-110
- ✅ Установка звонков между зарегистрированными абонентами
- ✅ Проксирование RTP трафика через сервер
- ✅ REST API для управления сервером
- ✅ Поддержка основных SIP методов (REGISTER, INVITE, BYE, ACK)
- ✅ Валидация SIP сообщений
- ✅ Система логирования с ротацией файлов
- ✅ Управление состоянием звонков
- ✅ Статистика и мониторинг
- ✅ Rate limiting для API
- ✅ Конфигурация через переменные окружения
- ✅ Обработка ошибок и восстановление
- ✅ Автоматическая очистка устаревших данных

## Установка

```bash
npm install
```

## Конфигурация

Скопируйте файл `env.example` в `.env` и настройте параметры:

```bash
cp env.example .env
```

Основные параметры конфигурации:
- `SERVER_ADDRESS` - IP адрес сервера для SDP
- `SIP_PORT` - порт для SIP протокола (по умолчанию: 5060)
- `API_PORT` - порт для REST API (по умолчанию: 3000)
- `RTP_PORT` - порт для RTP прокси (по умолчанию: 10000)
- `EXT_MIN/EXT_MAX` - диапазон валидных номеров (по умолчанию: 100-110)

## Запуск

```bash
# Разработка
npm run dev

# Продакшн
npm start
```

Сервер запустится на:
- SIP порт: 5060 (UDP)
- API порт: 3000 (HTTP)
- RTP порт: 10000 (UDP)



## API Endpoints

### Пользователи
```
GET /api/users - список зарегистрированных пользователей
GET /api/users/:username/calls - звонки конкретного пользователя
GET /api/users/expiring?within=30 - пользователи с истекающей регистрацией
DELETE /api/users/:username - удалить регистрацию пользователя
```

### Звонки
```
GET /api/calls - активные звонки
GET /api/calls/history?limit=50&offset=0 - история звонков
```

### Система
```
GET /api/extensions - список валидных номеров
GET /api/statistics - статистика сервера
GET /api/rtp-streams - активные RTP потоки
```

### Административные (только в режиме разработки)
```
POST /api/admin/clear-calls - очистить все звонки
POST /api/admin/clear-users - очистить всех пользователей
```

## Поддерживаемые номера

- 100
- 101
- 102
- 103
- 104
- 105
- 106
- 107
- 108
- 109
- 110

## SIP Сообщения

### REGISTER
Регистрация абонента на сервере.

### INVITE
Установка звонка между двумя абонентами.

### BYE
Завершение активного звонка.

## RTP Прокси

Сервер автоматически проксирует RTP трафик между абонентами, изменяя SDP сообщения для направления медиа-потоков через сервер.

## Логирование

Сервер использует структурированное логирование с ротацией файлов:

### Уровни логирования
- `error` - критические ошибки
- `warn` - предупреждения
- `info` - информационные сообщения
- `debug` - отладочная информация

### Файлы логов
- `./logs/sip-server.log` - основные логи
- `./logs/error.log` - только ошибки

### Настройка логирования
```bash
LOG_LEVEL=info                    # Уровень логирования
LOG_FILE=./logs/sip-server.log    # Путь к файлу логов
LOG_MAX_SIZE=10m                  # Максимальный размер файла
LOG_MAX_FILES=5                   # Количество файлов ротации
```

## Мониторинг

### Статистика сервера
```
GET /api/statistics
```

Возвращает:
- Статистика звонков (активные, завершенные, средняя длительность)
- Статистика пользователей (зарегистрированные, по адресам)
- Статистика RTP потоков
- Информация о сервере (uptime, память, версия Node.js)
```

## Примеры использования

### Регистрация абонента 100
```
REGISTER sip:100@server.com SIP/2.0
Via: SIP/2.0/UDP client1:5060
From: <sip:100@server.com>
To: <sip:100@server.com>
Contact: <sip:100@client1:5060>
Call-ID: abc123
CSeq: 1 REGISTER
Expires: 3600
```

### Звонок от 100 к 101
```
INVITE sip:101@server.com SIP/2.0
Via: SIP/2.0/UDP client1:5060
From: <sip:100@server.com>
To: <sip:101@server.com>
Contact: <sip:100@client1:5060>
Call-ID: def456
CSeq: 1 INVITE
Content-Type: application/sdp
Content-Length: [длина SDP]

[SDP содержимое]
``` 